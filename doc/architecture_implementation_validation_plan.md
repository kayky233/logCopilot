# 多组件日志诊断方案：实现与验证（低成本落地版）

## 1. 目标与原则

**目标**：在不依赖真实生产日志的前提下，快速验证“组件无关内核 + 可插拔 SkillPack + 渐进式检索 + 融合推理”是否可行，并形成可扩展实现基线。

**核心原则**：
- 先验证架构正确性与推理闭环，再验证数据规模效果。
- 新增组件仅新增 SkillPack，Core 不做组件特化改造。
- 检索与推理解耦：组件负责知识供给，Core 负责策略编排。

---

## 2. 总体架构

### 2.1 Core（平台内核）

Core 仅提供通用能力，不承载具体组件知识：

1. 日志接入与结构化
2. 组件识别与路由
3. 渐进式检索调度
4. 推理编排
5. 多组件结果融合
6. 标准化 RCA 输出

### 2.2 SkillPack（组件知识包）

按组件独立封装（如 Clock / BSP / Switch / iWare / BB Device）。

每个 SkillPack 必须具备：
- **知识索引**：章节级或条目级最小知识单元索引。
- **检索接口**：`query + scope + budget -> snippets`。
- **事件规范化器**：组件日志到统一事件模型映射。
- **信号/规则字典**：告警码、状态、阈值、典型模式。

可选增强：
- Playbook（诊断流程模板）
- 命令模板
- 参数映射表

---

## 3. 统一事件模型

建议统一字段如下：

- `timestamp`
- `component`
- `module`
- `level`
- `event_type`
- `keywords`
- `attributes`（键值对）

作用：让来自不同组件的日志进入同一推理空间，支持因果链拼接。

---

## 4. 渐进式披露策略（由 Core 控制）

建议分层：
- **L0**：组件背景摘要
- **L1**：原理知识
- **L2**：规则/阈值/告警
- **L3**：配置/命令/运维动作

调度规则：
- 默认从 L0/L1 开始；
- 当模型出现“证据不足”或“需阈值确认”时再升级检索层级；
- 每轮检索受 token 预算限制；
- 达到上限后停止扩检并输出置信度与缺口说明。

---

## 5. 多组件路由与融合

### 5.1 路由
- 输入日志先做组件识别。
- 按事件密度、严重级别、时序相关性分配检索优先级与预算。

### 5.2 融合
- 将各组件结论合并为统一因果链，生成 RCA。

示例：
`Switch 端口抖动 -> 1588 抖动 -> Clock Holdover -> 小区去激活`

---

## 6. 输出规范（统一报告模板）

每次诊断输出固定结构：

1. 现象摘要
2. 根因判断（含置信度）
3. 影响范围
4. 建议动作
5. 证据引用（日志片段 + 知识片段）

---

## 7. 低成本验证方案（无真实日志）

## 阶段 1：知识检索能力

**输入**：单组件（建议 Clock）少量索引 + 手工问题。

示例问题：
- 1588 正常锁定时间多久？
- 什么情况下进入 Holdover？

**通过标准**：
- 能命中正确知识片段
- 不需要加载全文
- 回答逻辑自洽

## 阶段 2：事件规范化

**输入**：10 条模拟日志，如：
- `[CLK][WARN] reference lost`
- `[CLK][INFO] enter holdover`

**通过标准**：
- 统一字段齐全
- `event_type` 与 `keywords` 语义稳定

## 阶段 3：单组件推理闭环

**输入事件**：
- `unlock timeout`
- `enter holdover`

**期望输出**：
- 根因：参考源异常
- 建议：检查同步源链路

**通过标准**：
- 有结论
- 有解释
- 有证据引用

## 阶段 4：渐进式披露有效性

**观察点**：
- 首次回答不拉全文
- 仅在需要门限/规则时扩检
- 检索轮次与 token 使用受控

## 阶段 5：多组件融合

**构造场景**：
- Switch：`port flap`
- Clock：`holdover`

**期望**：
输出因果链 `Switch 异常 -> 同步抖动 -> Clock 异常`。

---

## 8. 最小可行验证包（MVP）

仅需：
1. 1 个组件 SkillPack（Clock）
2. 20 行模拟日志
3. 5 条手工期望 RCA

即可完成架构可行性验证。

---

## 9. 成功判据

满足以下 4 点即可判定工程可行：
- 能跑通端到端闭环
- 能解释跨事件因果
- 能控制上下文与检索成本
- 新增组件仅需新增 SkillPack

---

## 10. 下一步落地建议

1. 先完成 Clock SkillPack（索引/规范化器/规则字典）。
2. 在 Core 增加统一事件模型与渐进式检索调度器。
3. 接入模拟日志评测脚本，输出固定 RCA 报告。
4. 通过 MVP 后再扩展 BSP / Switch，验证多组件融合稳定性。

